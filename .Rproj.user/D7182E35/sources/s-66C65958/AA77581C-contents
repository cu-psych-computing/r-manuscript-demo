---
title: "Guilt & Shame Data with Models from Kenny & Leach (2017)"
author: "KZ, 191119"
output:
  word_document:
    toc: yes
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_float: yes
---

# Mtg with Dave - notes
- go back to unstandardized
- submodel b: remove path for blame
- do we want to include blame in Submodels A and B? --> reviewers did not want a 0 df model --> a foil of one against the other
- We will come back to Common Cause Mediational Model
- submodel B df = -1 even with removing blame
- common method extended: need to fix common method first, but we also have the option to add m --> y path
- spurious model --> remove sad or upset (or create a composite)

# Plan for KZ
- KZ will clean up code and make questions that we have explicit
- Send to Dave (with data)

# Loading packages
```{r, results = "hide", message=F}
library(tidyverse)
library(lavaan)
library(car)
library(semPlot)
library(dplyr)
library(psych)
library(broom)
```

# Dataset from Colin
- Dataset of guilt and shame in two countries, but subsetted data to select country == 0.
- Y variable = affirmative action opportunity

```{r}
d <- read.csv("ucsc-UvA WINTER2001.csv") %>% 
  subset(., country == 0)
```

# Standardize relevant variables
```{r}

d$guilt <- d$emot_05 # pulled from the correlations SPSS file
d$guilt.z <- scale(d$guilt)

d$shame <- d$emot_13 # pulled from the correlations SPSS file
d$shame.z <- scale(d$shame)

# Potential candidate for W? 
d$em_blame.z <- scale(d$em_blame)

# Y variable = AA compensatory? 
d$aa_o.z <- scale(d$AffirmativeAction_opportunity)


# for use in general negative affect latent variable - candidate for G
d$em_sad.z <- scale(d$em_sad)
d$em_upset.z <- scale(d$em_upset)

```

# Correlations: Guilt, Shame, Sadness, and Outcome 
```{r}
cor.test(d$guilt, d$shame)
cor.test(d$guilt, d$em_blame)
cor.test(d$shame, d$em_blame)

cor.test(d$shame, d$aa_o.z)
cor.test(d$guilt, d$aa_o.z)
cor.test(d$em_blame, d$aa_o.z)

```


# Correlations Plot
```{r}
library(GGally)
d_sub <- dplyr::select(d, guilt.z, shame.z, aa_o.z, em_blame.z, em_sad.z, em_upset.z)
ggcorr(d_sub, label = TRUE, label_round = 2)
```

# Basic Standardized Regression (consistent with Commmon Cause Mediational Model)
```{r}
ccm <- lm(aa_o.z ~ guilt.z + shame.z, data = d)
tidy(ccm) %>% mutate_if(is.numeric, funs(round(., digits = 2)))
```
```{r}
# Testing whether the coefficients are different
linearHypothesis(ccm, "guilt.z = shame.z")
```
## SEM version of above
- Note: Path estimates are the same as in the regression model even with modeling covariance of guilt and shame. 

```{r} 
ccm_sem <- 'aa_o.z ~ x*guilt.z + z*shame.z
guilt.z ~~ shame.z

diff := x-z
'
ccm_sem_fit <- sem(ccm_sem, data = d)
summary(ccm_sem_fit)
fitMeasures(ccm_sem_fit)

semPaths(ccm_sem_fit, "std", "est",  edge.label.cex = 1, 
         fade = FALSE, 
         nCharNodes = 6)

```

# Common Cause Mediational Model, with G (Figure 3)
- Figure 3 suggests that paths for guilt and shame as indicators of G are fixed to be the same

- KZ: Model yields regression coefficients and guilt-shame covariance that are very similar to basic regression model above. 

- KZ: Had to fix variances of guilt and shame (and G) 1 to remove warnings. Variances of guilt and shame were negative if they were not constrained to have a variance of 1. 

- KZ: Should the covariance of X and Z not be modeled because G is already accounting for this? 

Notes 191119:
- KZ: remove covariance of X and Z because their relationship is already modeled through inclusion of latent 6. No variances fixed. 

```{r} 
# ccm_sem2 <- '
# G =~ c*guilt.z + c*shame.z

# aa_o.z ~ x*guilt.z + z*shame.z
# guilt.z ~~ shame.z
# guilt.z ~~ 1*guilt.z
# shame.z ~~ 1*shame.z
# G ~~ 1*G

# diff := x-z
# '


ccm_sem2 <- '
G =~ c*guilt.z + c*shame.z
aa_o.z ~ x*guilt.z + z*shame.z
diff := x-z
'
ccm_sem_fit2 <- sem(ccm_sem2, data = d)
summary(ccm_sem_fit2)
fitMeasures(ccm_sem_fit2)


semPaths(ccm_sem_fit2, "std", "est" ,  edge.label.cex = 1, 
         fade = FALSE,
         nCharNodes = 6)
```






# Extended Common Cause: Adding a Fourth Variable (Figure 6)
- Fourth variable (W) is blame

## Regression version
```{r}
ccm_sad <- lm(aa_o.z ~ guilt.z + shame.z + em_blame.z, data = d)
summary(ccm_sad)
```

```{r}
# testing whether the coefficients are different
linearHypothesis(ccm_sad, "guilt.z = shame.z")
```



# Common Cause: Adding a Fourth Variable ("Extended Model") - original
- Try to explicitly model latent variable G with indicators X (guilt), Z (shame), and W (blame). Fix W to Y path to 0, per the paper. 

- KZ: Had to fix variances to 1 to remove warning messages (without fixing variances to be 1, the df = -1 and SEs could not be estimated. Model was not identified) .
- KZ: Note that effect of G on Y is negative.
- KZ: The coefficients going from G to X, Z, and W here are all different, whereas in the Common Cause Mediation Model above, the coefficients of going from G to X and Z were the same--is this correct?
- KZ: Should the covariance of X and Z not be modeled because G is already accounting for this? 

Notes 191119:
- KZ: remove covariance of X and Z because their relationship is already modeled through inclusion of latent 6. No variances fixed. 


```{r}
# ccmw_sem <- '
#             G =~ guilt.z + shame.z + em_blame.z

#             aa_o.z ~ a*guilt.z + 0*em_blame.z + b*shame.z + g*G

#     guilt := a
#     shame := b
#     coeff_diff := guilt - shame

# guilt.z ~~ shame.z
# guilt.z ~~ 1*guilt.z
# shame.z ~~ 1*shame.z
# G ~~ 1*G'


ccmw_sem <- '
            G =~ guilt.z + shame.z + em_blame.z
            aa_o.z ~ a*guilt.z + 0*em_blame.z + b*shame.z + g*G'

ccmw_sem_fit <- sem(ccmw_sem, data = d)
summary(ccmw_sem_fit)
fitMeasures(ccmw_sem_fit)

semPaths(ccmw_sem_fit, "std", "est" ,  edge.label.cex = 1, fade = FALSE,
          nCharNodes = 6)
```


# Common Cause: Adding a Fourth Variable ("Extended Model") - with submodels (from appendix)
- "The Extended Model in Figure 6 is just-identified and so cannot be tested, but the two submodels can be tested.  Submodel A has g equal to zero, and Submodel B has paths a and b equal to zero. Submodel A has one degree of freedom and an over-identifying restriction that rWY.XZ = 0; that is, the partial correlation between W and Y controlling for X and Z is zero." (appendix p. 9)

## Submodel A
- From appendix: g equal to 0, one df, and effect of W on Y controlling for X and Z is 0. 

- KZ: Correct correct degrees of freedom (df = 1)

```{r}
# ccmwa_sem <- '
#             G =~ guilt.z + shame.z + em_blame.z

#             aa_o.z ~ a*guilt.z +  b*shame.z + 0*G + 0*em_blame.z

#     G ~~ 1*G
#     guilt := a
#     shame := b
#     coeff_diff := guilt - shame'

ccmwa_sem <- '
            G =~ guilt.z + shame.z + em_blame.z
            aa_o.z ~ a*guilt.z +  b*shame.z + 0*G + 0*em_blame.z'

ccmwa_sem_fit <- sem(ccmwa_sem, data = d)
summary(ccmwa_sem_fit)
fitMeasures(ccmwa_sem_fit)

semPaths(ccmwa_sem_fit, "std", "est" ,  edge.label.cex = 1, fade = FALSE,
          nCharNodes = 6)
```

## Submodel B
- From appendix: Single factor with four indicators. Paths a and b set to 0. df = 2 (p. 9). 
- KZ: Had to fix variance of blame 1 in order to get correct dfs, but this yields a warning and there are no estimates for SEs. 

Notes 191119:
- KZ: removed fixing of variances. 0 dfs and a got a warning.  

```{r}
# Submodel B

# ccmwb_sem <- '
#             G =~ guilt.z + shame.z + em_blame.z + aa_o.z

#             aa_o.z ~ 0*guilt.z +  0*shame.z + G + em_blame.z

#             em_blame.z ~~ 1*em_blame.z
#             G ~~ 1*G'

ccmwb_sem <- '
            G =~ guilt.z + shame.z +  aa_o.z
            aa_o.z ~ 0*guilt.z +  0*shame.z + G'

ccmwb_sem_fit <- sem(ccmwb_sem, data = d)
summary(ccmwb_sem_fit)
fitMeasures(ccmwb_sem_fit)

semPaths(ccmwb_sem_fit, "std", "est" ,  edge.label.cex = 1, fade = FALSE,
          nCharNodes = 6)
```



# Common Method
- Assumptions from p. 10:
1) Paths from M to X and M to Z are equal ("The method component, or M, is presumed to equally cause both X and Z.")
2) No M to Y path
3) Correlation between X and Z should be positive
4) M is uncorrelated with X' and Z', and X' and Z' are also uncorrelated with each other. 
5) M equally affects X and Z
6) "We should also note that for this model and all others, we have fixed the variance of the latent variable that causes X and Z to one (i.e., standardized it)".

- KZ: Paper reads, "In the Common Method Model standardized path a′ is very close to rXY and standardized path b′ is close to rZY" (p. 11), but we don't see this. rXY is .19 and rZY is .22, but the coefficients are Xp = .36 and Zp = .60. 
- KZ: Fixed variance of M to 1 given note on page 10. Had to fix variances of Xp and Zp to be 1 as well, otherwise variances estimates were negative. 

Notes 191119
- KZ: Did not fix variances to 1 and covs to 0 explicitly. Warning message that estimate ov variances are negative. 
- This chance DID match the paper in that the a and b paths are now very similar to the X-Y and Z-Y correlations. 

```{r}
# cmm_sem <- 'M =~ m*guilt.z + m*shame.z
#             Xp =~ guilt.z 
#             Zp =~ shame.z
#           aa_o.z ~ Xp + Zp

# guilt.z ~~ 1*guilt.z
# shame.z ~~ 1*shame.z
# M ~~ 1*M

# Xp ~~ 1*Xp
# Zp ~~ 1*Zp

# Xp ~~ 0*M
# Zp ~~ 0*M
# Xp ~~ 0*Zp
# '

cmm_sem <- 'M =~ m*guilt.z + m*shame.z
            Xp =~ guilt.z 
            Zp =~ shame.z
          aa_o.z ~ Xp + Zp
'
 
cmm_sem_fit <- sem(cmm_sem, data = d)
summary(cmm_sem_fit)
fitMeasures(cmm_sem_fit)


semPaths(cmm_sem_fit, "std", "est" ,  edge.label.cex = 1, fade = FALSE, 
          nCharNodes = 6)
```
 

## Common Method standardized paths based on formulas from Appendix 
- p. 7 of Appendix: 
- Estimates are in the neighborhood of the correlations, but not exactly the same. 

```{r}
# a' path: 
cor.test(d$guilt.z, d$aa_o.z)$estimate * sqrt(1 - cor.test(d$guilt.z, d$shame)$estimate)

# b' path: 
cor.test(d$shame, d$aa_o.z)$estimate * sqrt(1 - cor.test(d$guilt.z, d$shame)$estimate)
```



## Residualized scores based on formulas from Appendix 
- p.12 of Appendix: "Thus, the standardized regression coefficients of the residualized scores are essentially the correlations of the variables with Y."
- Estimates are in the neighborhood of the correlations, but not exactly the same. 
```{r}
# a' path: 
cor.test(d$guilt.z, d$aa_o.z)$estimate / sqrt(1 - cor.test(d$guilt.z, d$shame)$estimate^2)

# b' path: 
cor.test(d$shame, d$aa_o.z)$estimate / sqrt(1 - cor.test(d$guilt.z, d$shame)$estimate^2)
```

```{r}
cor.test(d$guilt.z, d$aa_o.z)$estimate
cor.test(d$shame, d$aa_o.z)$estimate
```

# Common method model, extended
- W and W', with W' having no path to Y
- KZ: not in paper or appendix but Colin and I thought it seemed worth trying

Notes 191119
- KZ: SEs not computed. 
```{r}
# cmmw_sem <- 'M =~ m*guilt.z + m*shame.z + m*em_blame.z
#               Xp =~ guilt.z 
#               Zp =~ shame.z
#               Wp =~ em_blame.z
#               Xp ~~ 0*Zp
#               Xp ~~ 0*Wp
#               Zp ~~ 0*Wp

#               aa_o.z ~ Xp + Zp + 0*Wp

# guilt.z ~~ 1*guilt.z
# shame.z ~~ 1*shame.z
# em_blame.z ~~ 1*em_blame.z
# M ~~ 1*M

# Xp ~~ 1*Xp
# Zp ~~ 1*Zp
# Wp ~~ 1*Wp


# Xp ~~ 0*M
# Zp ~~ 0*M
# Wp ~~ 0*M'

cmmw_sem <- 'M =~ m*guilt.z + m*shame.z + m*em_blame.z
              Xp =~ guilt.z 
              Zp =~ shame.z
              Wp =~ em_blame.z 
aa_o.z ~ Xp + Zp'
 
cmmw_sem_fit <- sem(cmmw_sem, data = d)
summary(cmmw_sem_fit)
fitMeasures(cmmw_sem_fit)


semPaths(cmmw_sem_fit, "std", "est",  edge.label.cex = 1, fade = FALSE, 
          nCharNodes = 6)

```

# Spurious Model - with general negative affect
- "With just three variables, the Common Cause Spurious Model can be estimated.  It can be viewed as single-factor latent variable, with the latent variable being G and the indicators being X, Z, and Y"

- KZ: Fixing variance of G to be 1 based on note on page 10 of paper ("We should also note that for this model and all others, we have fixed the variance of the latent variable that causes X and Z to one (i.e., standardized it)".)

```{r}
ccms_sem2 <- '

G =~ guilt.z + shame.z + em_sad.z + em_upset.z + aa_o.z

'
ccms_sem2_fit <- sem(ccms_sem2, data = d)
summary(ccms_sem2_fit)
fitMeasures(ccms_sem2_fit)


semPaths(ccms_sem2_fit, "std", "est" ,  edge.label.cex = 1, 
         fade = FALSE,
         nCharNodes = 6)
```


# Pull in fit statistics RMSEA for models
## Summary of RMSEAs:
```{r}
rmseas <- data.frame(
  model = c("basic model",
            "common cause latent G",
            "common cause extended",
            "common cause extended submodel A",
            "common cause extended submodel B",
            "common method",
            "common cause spurious negaffect G",
            "common method extended"),

  modelobject = c("ccm_sem_fit",
                  "ccm_sem_fit2",
                  "ccmw_sem_fit",
                  "ccmwa_sem",
                  "ccmwa_sem",
                  "cmm_sem_fit",
                  "ccms_sem2_fit",
                  "cmmw_sem_fit"),

  rmsea = c(fitMeasures(ccm_sem_fit, "rmsea"),
            fitMeasures(ccm_sem_fit2, "rmsea"),
            fitMeasures(ccmw_sem_fit, "rmsea"),
            fitMeasures(ccmwa_sem_fit, "rmsea"),
            fitMeasures(ccmwb_sem_fit, "rmsea"),
            fitMeasures(cmm_sem_fit, "rmsea"),
            fitMeasures(ccms_sem2_fit, "rmsea"),
            fitMeasures(cmmw_sem_fit, "rmsea"))
)

rmseas %>% dplyr::arrange(rmseas$rmsea)
```

